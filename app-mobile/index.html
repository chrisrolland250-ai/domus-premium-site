<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Domus Premium – Saisie & Suivi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 16px; line-height: 1.4; }
    h2, h3 { margin-top: 1.5em; }
    label { display: block; font-weight: 600; margin-top: 0.5em; }
    input, textarea, button { width: 100%; max-width: 100%; box-sizing: border-box; margin-top: 0.25em; padding: 6px 8px; }
    button { cursor: pointer; margin-top: 0.75em; }
    table { border-collapse: collapse; width: 100%; margin-top: 1em; }
    th, td { border: 1px solid #ddd; padding: 6px; font-size: 0.9em; }
    th { background: #f5f5f5; }
    .dp-app-mobile { margin-bottom: 2em; }
    .pin-area, .protected-area { max-width: 900px; margin: 0 auto; }
    .pin-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .pin-row input { max-width: 120px; }
    .note { font-size: 0.85em; color: #555; }
    .actions-inline button { width: auto; display: inline-block; }
    .actions-inline button + button { margin-left: 4px; }
  </style>
</head>
<body>

  <!-- ACCÈS PAR CODE PIN -->
  <div class="pin-area" id="pin-area">
    <h2>Domus Premium – Accès</h2>
    <div class="pin-row">
      <label for="dp-pin">Code PIN (4 chiffres)</label>
      <input type="password" id="dp-pin" maxlength="4" inputmode="numeric" autocomplete="off">
      <button type="button" onclick="dpValidatePin()">Valider</button>
    </div>
    <p class="note">
      Le code est stocké uniquement sur cet appareil (localStorage).
      Il sert juste à verrouiller l’accès à cette page.
    </p>
  </div>

  <!-- CONTENU PROTÉGÉ -->
  <div class="protected-area" id="protected-area" style="display:none;">

    <h2>Domus Premium – Saisie &amp; Suivi</h2>

    <!-- FORMULAIRE DE SAISIE CHANTIER -->
    <div class="dp-app-mobile">
      <h3>Saisie chantier</h3>

      <!-- Champ caché pour l'id (utilisé en modification) -->
      <input type="hidden" id="chantier-id">

      <label for="chantier-date">Date :</label>
      <input type="date" id="chantier-date">

      <label for="chantier-client">Client :</label>
      <input type="text" id="chantier-client" placeholder="Nom du client">

      <label for="chantier-description">Description :</label>
      <input type="text" id="chantier-description" placeholder="Ex : Nettoyage complet, petits travaux, etc.">

      <label for="chantier-montant">Montant (CA TTC) :</label>
      <input type="number" step="0.01" id="chantier-montant">

      <label for="chantier-fournitures">Fournitures (€) :</label>
      <input type="number" step="0.01" id="chantier-fournitures">

      <label for="chantier-remarques">Remarques :</label>
      <textarea id="chantier-remarques" rows="2"></textarea>

      <label for="chantier-saisi-par">Saisi par :</label>
      <input type="text" id="chantier-saisi-par" value="Christophe">

      <button type="button" onclick="saveChantierFromForm()">Enregistrer le chantier</button>
    </div>

    <!-- HISTORIQUE DES CHANTIERS -->
    <div class="dp-app-mobile">
      <h3>Historique des chantiers (synchronisé)</h3>
      <p class="note">
        Fonctionne hors connexion : les données sont enregistrées dans cet appareil et se synchronisent avec Google Sheets
        dès que le réseau est disponible. Vous pouvez ouvrir cette page sur un autre PC ou téléphone et retrouver
        l’historique commun.
      </p>

      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Client</th>
            <th>CA</th>
            <th>Fournitures</th>
            <th>Remarques</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="chantier-table-body"></tbody>
      </table>
    </div>

  </div>

<script>
  // =============================
  // CONFIG
  // =============================
  const API_URL = 'https://script.google.com/macros/s/AKfycbxFj76ORy0fOtaub2icIkEcPyNlXg1bPFFatdHNcqlNy7_rord9CoXQFP3uTzDtG-h2/exec';

  const STORAGE_KEY = 'domus_chantiers_v1';
  const STORAGE_LAST_SYNC = 'domus_chantiers_last_sync_v1';
  const PIN_STORAGE_KEY = 'domus_dp_pin_v1';

  let chantiers = [];

  // =============================
  // GESTION PIN
  // =============================
  function dpIsPinSet() {
    return !!localStorage.getItem(PIN_STORAGE_KEY);
  }

  function dpValidatePin() {
    const input = document.getElementById('dp-pin');
    const val = (input.value || '').trim();

    if (val.length !== 4 || !/^[0-9]{4}$/.test(val)) {
      alert('Merci de saisir un code PIN à 4 chiffres.');
      return;
    }

    const existing = localStorage.getItem(PIN_STORAGE_KEY);

    if (!existing) {
      // Premier paramétrage : on enregistre ce code comme référence
      if (confirm('Définir ce code PIN pour cet appareil ?')) {
        localStorage.setItem(PIN_STORAGE_KEY, val);
        dpUnlock();
      }
    } else {
      if (val === existing) {
        dpUnlock();
      } else {
        alert('Code PIN incorrect.');
      }
    }

    input.value = '';
  }

  function dpUnlock() {
    document.getElementById('pin-area').style.display = 'none';
    document.getElementById('protected-area').style.display = 'block';
  }

  // =============================
  // INITIALISATION
  // =============================
  document.addEventListener('DOMContentLoaded', () => {
    // Si un PIN est déjà défini, on affiche directement le champ PIN,
    // sinon le premier code saisi définira le PIN de l’appareil.
    if (!dpIsPinSet()) {
      // pas de PIN enregistré → l’utilisateur en crée un
    }

    loadFromLocal();
    renderChantiers();
    syncFromServer();
    pushPendingChanges();

    window.addEventListener('online', () => {
      syncFromServer();
      pushPendingChanges();
    });
  });

  // =============================
  // LOCAL STORAGE
  // =============================
  function loadFromLocal() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        chantiers = JSON.parse(raw);
      } else {
        chantiers = [];
      }
    } catch (e) {
      console.warn('Erreur loadFromLocal', e);
      chantiers = [];
    }
  }

  function saveToLocal() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(chantiers));
  }

  function getLastSync() {
    return localStorage.getItem(STORAGE_LAST_SYNC) || '0';
  }

  function setLastSync(ts) {
    localStorage.setItem(STORAGE_LAST_SYNC, ts.toString());
  }

  // =============================
  // FORMULAIRE
  // =============================
  function getFormValues() {
    return {
      id: document.getElementById('chantier-id').value || null,
      date: document.getElementById('chantier-date').value,
      client: document.getElementById('chantier-client').value,
      description: document.getElementById('chantier-description').value,
      montant: document.getElementById('chantier-montant').value,
      fournitures: document.getElementById('chantier-fournitures').value,
      remarques: document.getElementById('chantier-remarques').value,
      saisi_par: document.getElementById('chantier-saisi-par').value || ''
    };
  }

  function clearForm() {
    document.getElementById('chantier-id').value = '';
    document.getElementById('chantier-date').value = '';
    document.getElementById('chantier-client').value = '';
    document.getElementById('chantier-description').value = '';
    document.getElementById('chantier-montant').value = '';
    document.getElementById('chantier-fournitures').value = '';
    document.getElementById('chantier-remarques').value = '';
  }

  function saveChantierFromForm() {
    const data = getFormValues();

    if (!data.date || !data.client) {
      alert('Merci de renseigner au minimum la date et le client.');
      return;
    }

    if (!data.id) {
      // Nouveau chantier
      data.id = 'LOCAL_' + Date.now() + '_' + Math.floor(Math.random() * 100000);
      data.deleted = 'FALSE';
      data.updatedAt = Date.now().toString();
      data._syncStatus = 'pending';

      chantiers.push(data);
    } else {
      // Mise à jour d’un chantier existant
      const idx = chantiers.findIndex(c => c.id === data.id);
      if (idx !== -1) {
        chantiers[idx] = {
          ...chantiers[idx],
          ...data,
          updatedAt: Date.now().toString(),
          _syncStatus: 'pending'
        };
      } else {
        // Cas limite : l’id n’existait plus en local
        data.deleted = 'FALSE';
        data.updatedAt = Date.now().toString();
        data._syncStatus = 'pending';
        chantiers.push(data);
      }
    }

    saveToLocal();
    renderChantiers();
    pushPendingChanges();
    clearForm();
  }

  // =============================
  // GESTION DES LIGNES
  // =============================
  function editChantier(id) {
    const c = chantiers.find(c => c.id === id);
    if (!c) return;

    document.getElementById('chantier-id').value = c.id;
    document.getElementById('chantier-date').value = c.date || '';
    document.getElementById('chantier-client').value = c.client || '';
    document.getElementById('chantier-description').value = c.description || '';
    document.getElementById('chantier-montant').value = c.montant || '';
    document.getElementById('chantier-fournitures').value = c.fournitures || '';
    document.getElementById('chantier-remarques').value = c.remarques || '';
  }

  function deleteChantier(id) {
    const idx = chantiers.findIndex(c => c.id === id);
    if (idx === -1) return;

    if (!confirm('Supprimer ce chantier de l’historique ?')) return;

    chantiers[idx].deleted = 'TRUE';
    chantiers[idx].updatedAt = Date.now().toString();
    chantiers[idx]._syncStatus = 'pending';

    saveToLocal();
    renderChantiers();
    pushPendingChanges();
  }

  // =============================
  // AFFICHAGE
  // =============================
  function renderChantiers() {
    const tbody = document.getElementById('chantier-table-body');
    if (!tbody) return;

    tbody.innerHTML = '';

    chantiers
      .filter(c => c.deleted !== 'TRUE')
      .sort((a, b) => (a.date || '').localeCompare(b.date || ''))
      .forEach(c => {
        const tr = document.createElement('tr');

        const tdDate = document.createElement('td');
        tdDate.textContent = c.date || '';
        tr.appendChild(tdDate);

        const tdClient = document.createElement('td');
        tdClient.textContent = c.client || '';
        tr.appendChild(tdClient);

        const tdMontant = document.createElement('td');
        tdMontant.textContent = c.montant || '';
        tr.appendChild(tdMontant);

        const tdFournitures = document.createElement('td');
        tdFournitures.textContent = c.fournitures || '';
        tr.appendChild(tdFournitures);

        const tdRemarques = document.createElement('td');
        tdRemarques.textContent = c.remarques || '';
        tr.appendChild(tdRemarques);

        const tdActions = document.createElement('td');
        tdActions.className = 'actions-inline';

        const btnEdit = document.createElement('button');
        btnEdit.textContent = 'Modifier';
        btnEdit.type = 'button';
        btnEdit.onclick = () => editChantier(c.id);
        tdActions.appendChild(btnEdit);

        const btnDel = document.createElement('button');
        btnDel.textContent = 'Supprimer';
        btnDel.type = 'button';
        btnDel.onclick = () => deleteChantier(c.id);
        tdActions.appendChild(btnDel);

        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
  }

  // =============================
  // SYNCHRONISATION AVEC GOOGLE SHEETS
  // =============================
  async function syncFromServer() {
    try {
      const since = getLastSync();
      const url = `${API_URL}?since=${encodeURIComponent(since)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();

      if (!data.items || !Array.isArray(data.items)) return;

      const byId = {};
      chantiers.forEach(c => { byId[c.id] = c; });

      data.items.forEach(item => {
        delete item._syncStatus;

        if (byId[item.id]) {
          Object.assign(byId[item.id], item, { _syncStatus: 'synced' });
        } else {
          chantiers.push({ ...item, _syncStatus: 'synced' });
        }
      });

      setLastSync(Date.now());
      saveToLocal();
      renderChantiers();
    } catch (e) {
      console.warn('syncFromServer error', e);
    }
  }

  async function pushPendingChanges() {
    const pending = chantiers.filter(c => c._syncStatus === 'pending');
    if (pending.length === 0) return;

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: pending })
      });

      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      if (data.error) {
        console.warn('pushPendingChanges error from server', data.error);
        return;
      }

      chantiers.forEach(c => {
        if (c._syncStatus === 'pending') {
          c._syncStatus = 'synced';
        }
      });

      setLastSync(Date.now());
      saveToLocal();
    } catch (e) {
      console.warn('pushPendingChanges error', e);
    }
  }
</script>

</body>
</html>
